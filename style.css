import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import { getFirestore, collection, addDoc, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAYwc4wlCgMNZoikTbt-ph48zatsUo6Kw0",
  authDomain: "oasis-own.firebaseapp.com",
  projectId: "oasis-own",
  storageBucket: "oasis-own.firebasestorage.app",
  messagingSenderId: "621399635023",
  appId: "1:621399635023:web:7bb98a8f74eb72cb9fa63a"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

let STATE = {
    user: null, cart: [],
    products: [
        {id: 1, name: "Chronos V1", price: 299, img: "https://picsum.photos/400/500?random=101"},
        {id: 2, name: "Neural Buds", price: 149, img: "https://picsum.photos/400/500?random=102"},
        {id: 3, name: "Ghost Runner", price: 599, img: "https://picsum.photos/400/500?random=103"},
        {id: 4, name: "Apex Shell", price: 199, img: "https://picsum.photos/400/500?random=104"}
    ]
};

// --- AUTH & INITIALIZATION ---
window.loginWithGoogle = () => signInWithPopup(auth, provider);
onAuthStateChanged(auth, (user) => {
    if (user) {
        STATE.user = user;
        document.getElementById('authScreen').classList.add('opacity-0', 'pointer-events-none');
        document.getElementById('mainApp').classList.remove('hidden');
        setTimeout(() => document.getElementById('mainApp').classList.add('opacity-100'), 100);
        document.getElementById('userImg').src = user.photoURL;
        // CHANGE THIS TO YOUR EMAIL FOR ADMIN ACCESS
        if(user.email === "ahmedboss8603@gmail.com") document.getElementById('adminBtn').classList.remove('hidden');
        renderProducts();
    }
});

// --- SHOP LOGIC ---
function renderProducts() {
    document.getElementById('productGrid').innerHTML = STATE.products.map(p => `
        <div class="product-card p-6 group">
            <div class="overflow-hidden rounded-[40px] mb-8 bg-black">
                <img src="${p.img}" class="w-full h-80 object-cover opacity-80 group-hover:opacity-100 group-hover:scale-110 transition duration-1000">
            </div>
            <h3 class="text-[10px] tracking-[5px] text-gray-500 font-black mb-2 uppercase">${p.name}</h3>
            <div class="flex justify-between items-end">
                <p class="text-4xl font-black italic italic">$${p.price}</p>
                <button onclick="addToCart(${p.id})" class="bg-white text-black w-14 h-14 rounded-2xl hover:bg-cyan-500 transition-all flex items-center justify-center">
                    <i class="fa-solid fa-plus text-xl"></i>
                </button>
            </div>
        </div>
    `).join('');
}

window.addToCart = (id) => {
    STATE.cart.push(STATE.products.find(x => x.id === id));
    updateCartUI();
};

function updateCartUI() {
    let total = 0;
    document.getElementById('cartItems').innerHTML = STATE.cart.map((item, i) => {
        total += item.price;
        return `<div class="bg-white/5 p-6 rounded-[30px] flex justify-between items-center">
            <div><p class="text-[10px] text-cyan-500 font-bold uppercase tracking-widest">${item.name}</p><b class="text-2xl italic font-black">$${item.price}</b></div>
            <button onclick="STATE.cart.splice(${i},1); updateCartUI();" class="text-red-500/50 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
        </div>`;
    }).join('');
    document.getElementById('cartTotal').innerText = `$${total}`;
    document.getElementById('cartCount').innerText = STATE.cart.length;
}

window.processPayment = async () => {
    if(!STATE.cart.length) return;
    await addDoc(collection(db, "orders"), {
        uid: STATE.user.uid, email: STATE.user.email,
        total: STATE.cart.reduce((a,b)=>a+b.price,0), timestamp: new Date().toISOString()
    });
    confetti({ particleCount: 200, spread: 80, colors: ['#00f2ff', '#ffffff'] });
    alert("ORDER ARCHIVED SUCCESSFULLY");
    STATE.cart = []; updateCartUI(); toggleCart();
};

// --- HELPERS ---
window.toggleCart = () => document.getElementById('cartSidebar').classList.toggle('active');
window.toggleHistory = async () => {
    document.getElementById('historySidebar').classList.toggle('active');
    const q = query(collection(db, "orders"), where("uid", "==", STATE.user.uid), orderBy("timestamp", "desc"));
    const snap = await getDocs(q);
    document.getElementById('historyItems').innerHTML = snap.docs.map(doc => `
        <div class="bg-white/5 p-8 rounded-[40px]">
            <p class="text-[9px] font-black text-cyan-500 mb-2">#${doc.id.slice(0,8)}</p>
            <p class="text-4xl font-black italic">$${doc.data().total}</p>
        </div>
    `).join('');
};

// --- PARTICLES ---
particlesJS("particles-js", {
    "particles": {
        "number": { "value": 100 },
        "color": { "value": ["#00f2ff", "#ffffff"] },
        "opacity": { "value": 0.4 },
        "size": { "value": 2, "random": true },
        "line_linked": { "enable": true, "distance": 150, "color": "#00f2ff", "opacity": 0.1 },
        "move": { "enable": true, "speed": 1.5 }
    },
    "interactivity": { "events": { "onhover": { "enable": true, "mode": "grab" } } }
});
