<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oasis Admin - Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-10">

    <div class="max-w-xl mx-auto bg-white p-10 rounded-[40px] shadow-2xl">
        <h2 class="text-3xl font-black mb-8">Publish New Item</h2>
        
        <div class="space-y-4">
            <input type="text" id="p-name" placeholder="Product Name" class="w-full border-2 p-4 rounded-2xl outline-none focus:border-black">
            <input type="number" id="p-price" placeholder="Price (5000)" class="w-full border-2 p-4 rounded-2xl outline-none focus:border-black">
            <input type="text" id="p-image" placeholder="Image URL (Chota Link use karein)" class="w-full border-2 p-4 rounded-2xl outline-none focus:border-black">
            
            <button id="addBtn" onclick="updateStore()" class="bg-green-600 text-white w-full py-5 rounded-2xl font-black text-xl hover:bg-green-700 transition">Update Oasis Store</button>
        </div>
        
        <p id="status" class="mt-6 text-center font-bold"></p>
    </div>

<script>
    const TOKEN = "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"; 
    const REPO = "NeverPlayz7/oasis-store";

    async function updateStore() {
        const name = document.getElementById('p-name').value;
        const price = document.getElementById('p-price').value;
        const image = document.getElementById('p-image').value;
        const status = document.getElementById('status');
        const btn = document.getElementById('addBtn');

        if(!name || !price || !image) return alert("All fields are required!");
        if(image.length > 500) return alert("Image URL bohat bada hai! Kisi website se image link copy karke dalen.");

        btn.disabled = true;
        status.innerHTML = "⏳ GitHub se connect ho raha hai...";

        try {
            // 1. File mangwao
            const res = await fetch(`https://api.github.com/repos/${REPO}/contents/data.json`, {
                headers: { "Authorization": `token ${TOKEN}` }
            });
            
            const file = await res.json();
            
            // ERROR FIX: Decode karne se pehle check
            let content = [];
            try {
                // Agar content sahi hai to decode karo, warna khali array rakho
                const decodedData = decodeURIComponent(escape(atob(file.content.replace(/\s/g, ''))));
                content = JSON.parse(decodedData);
            } catch(e) {
                console.log("File was empty or corrupted, resetting to []");
                content = [];
            }

            // 2. Naya data add karo
            content.push({ name, price, image });

            // 3. Wapas bhejo
            const update = await fetch(`https://api.github.com/repos/${REPO}/contents/data.json`, {
                method: "PUT",
                headers: { "Authorization": `token ${TOKEN}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    message: `Added ${name}`,
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2)))),
                    sha: file.sha
                })
            });

            if(update.ok) {
                status.innerHTML = "<span class='text-green-600'>✅ Mubarak ho! Product add ho gaya.</span>";
                document.getElementById('p-name').value = "";
                document.getElementById('p-price').value = "";
                document.getElementById('p-image').value = "";
            } else {
                throw new Error("GitHub Update Failed");
            }

        } catch(e) {
            status.innerHTML = `<span class='text-red-500'>❌ Error: ${e.message}</span>`;
            console.error(e);
        }
        btn.disabled = false;
    }
</script>
</body>
</html>
